# -------------------------------
# modules/weather_module.py
# -------------------------------
import requests

# âœ… ì£¼ìš” ì§€ì—­ í•œê¸€ â†’ ì¢Œí‘œ ë§¤í•‘ (ì/ë©´/ë™ ì§€ì›)
CITY_COORDS = {
    "ì„±ë‚¨ì‹œ ìˆ˜ì •êµ¬": (37.4386, 127.1378),
    "ì„±ë‚¨ì‹œ ì¤‘ì›êµ¬": (37.4325, 127.1315),
    "ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬": (37.3786, 127.1176),
    "ë‹¬ì„±êµ° ë‹¤ì‚¬ì": (35.8664, 128.4586),
    "ì„œìš¸": (37.5665, 126.9780),
    "ë¶€ì‚°": (35.1796, 129.0756),
    "ëŒ€êµ¬": (35.8714, 128.6014),
    "ì¸ì²œ": (37.4563, 126.7052),
    "ê´‘ì£¼": (35.1595, 126.8526),
    "ëŒ€ì „": (36.3504, 127.3845),
    "ìš¸ì‚°": (35.5384, 129.3114),
    "ìˆ˜ì›": (37.2636, 127.0286),
    "ì°½ì›ì‹œ ì˜ì°½êµ¬": (35.2416, 128.6811),
    "ì œì£¼ì‹œ": (33.4996, 126.5312),
    "ì œì£¼ë„": (33.4996, 126.5312),
}

def get_weather(city: str, WEATHER_KEY: str) -> str:
    """
    ë„ì‹œ ì´ë¦„(city)ì„ ìœ„ë„/ê²½ë„ë¡œ ìë™ ë³€í™˜í•˜ì—¬ ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜´.
    - ë¹„, ëˆˆ, ì²œë‘¥, í­ì—¼, í•œíŒŒ ê°ì§€
    - ì˜¤ë¥˜ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë©”ì‹œì§€ ë°˜í™˜
    """
    try:
        # ğŸ” 1ï¸âƒ£ ë„ì‹œ ì¢Œí‘œ ì°¾ê¸°
        coords = CITY_COORDS.get(city.strip())
        if not coords:
            return f"âŒ '{city}'ëŠ” ë“±ë¡ë˜ì§€ ì•Šì€ ì§€ì—­ì´ì—ìš”.\nì˜ˆ: ì„±ë‚¨ì‹œ ìˆ˜ì •êµ¬, ëŒ€êµ¬, ì œì£¼ë„"

        lat, lon = coords

        # ğŸŒ¦ï¸ 2ï¸âƒ£ OpenWeather API ìš”ì²­ (ì¢Œí‘œ ê¸°ë°˜)
        url = f"http://api.openweathermap.org/data/2.5/weather?lat={lat}&lon={lon}&appid={WEATHER_KEY}&units=metric&lang=kr"
        res = requests.get(url, timeout=5)

        if res.status_code != 200:
            return f"âš ï¸ {city}ì˜ ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì‘ë‹µ ì½”ë“œ: {res.status_code})"

        data = res.json()
        temp = data.get("main", {}).get("temp")
        desc = data.get("weather", [{}])[0].get("description", "ì •ë³´ ì—†ìŒ")

        # ğŸ§Š 3ï¸âƒ£ ì˜¨ë„ ëˆ„ë½ ì‹œ
        if temp is None:
            return f"âš ï¸ {city}ì˜ ì˜¨ë„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

        # ğŸŒ¤ï¸ 4ï¸âƒ£ ê¸°ìƒ ê²½ê³  ë©”ì‹œì§€ ìë™ ìƒì„±
        alerts = []
        if any(k in desc for k in ["ë¹„", "ì†Œë‚˜ê¸°", "rain"]):
            alerts.append("â˜” ë¹„ê°€ ì˜¤ë‹ˆê¹Œ ìš°ì‚° ì±™ê¸°ê¸°!")
        if any(k in desc for k in ["ëˆˆ", "snow"]):
            alerts.append("â„ï¸ ëˆˆì´ ë‚´ë ¤ìš”, ë¯¸ë„ëŸ¬ì§€ì§€ ì•Šê²Œ ì¡°ì‹¬í•´ìš”!")
        if "ì²œë‘¥" in desc or "thunder" in desc.lower():
            alerts.append("âš¡ ì²œë‘¥Â·ë²ˆê°œ ì£¼ì˜! ì™¸ì¶œì€ í”¼í•˜ëŠ” ê²Œ ì¢‹ì•„ìš”.")
        if temp <= 0:
            alerts.append("ğŸ¥¶ í•œíŒŒ ì£¼ì˜! ì‹¤ë‚´ ìš´ë™ ì¶”ì²œì´ì—ìš”.")
        if temp >= 27:
            alerts.append("ğŸ¥µ ë”ìš´ ë‚ ì”¨ì˜ˆìš”! ìˆ˜ë¶„ ìì£¼ ì„­ì·¨í•´ìš”.")

        # âœ¨ 5ï¸âƒ£ ê²°ê³¼ ë©”ì‹œì§€ êµ¬ì„±
        alert_text = "\n".join(alerts)
        base_msg = f"ğŸ“ {city}ì˜ í˜„ì¬ ì˜¨ë„ëŠ” {temp:.1f}Â°C, ë‚ ì”¨ëŠ” {desc}ì…ë‹ˆë‹¤."
        return f"{base_msg}\n{alert_text if alert_text else 'ğŸŒ¤ï¸ ì˜¤ëŠ˜ì€ ìš´ë™í•˜ê¸° ì¢‹ì€ ë‚ ì”¨ì˜ˆìš”!'}"

    except requests.exceptions.RequestException:
        return f"ğŸš¨ {city}ì˜ ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
